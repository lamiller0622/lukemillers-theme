name: Deploy Sage Theme to IONOS

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.php"
      - "app/**"
      - "resources/**"
      - "composer.json"
      - "composer.lock"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          tools: composer
          coverage: none

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Cache vendor/
        uses: actions/cache@v4
        with:
          path: vendor
          key: vendor-${{ hashFiles('composer.lock') }}
          restore-keys: |
            vendor-

      - name: Cache Composer download cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: composer-cache-${{ hashFiles('composer.lock') }}
          restore-keys: |
            composer-cache-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            node_modules-

      - name: Install PHP deps (no-dev, optimized)
        run: composer install --no-dev --prefer-dist -o --no-progress --no-interaction

      - name: Install Node deps
        run: npm ci

      - name: Build production assets
        run: npm run build

      # create deploy/ first, then add debug markers *inside* it
      - name: Prepare deploy folder
        run: |
          rm -rf deploy
          mkdir -p deploy
          rsync -a --delete \
            --exclude ".git*" \
            --exclude ".github" \
            --exclude "node_modules" \
            --exclude ".env" \
            --exclude "tests" \
            --exclude "vendor/bin" \
            --exclude "*.map" \
            ./ deploy/
          echo "Deployed $GITHUB_SHA on $(date -u +%FT%TZ)" > deploy/version.txt
          cat > deploy/pathcheck.php <<'PHP'
          <?php
          echo 'ABSPATH: ' . ABSPATH . PHP_EOL;
          echo 'Theme dir: ' . get_stylesheet_directory() . PHP_EOL;
          PHP

      - name: Deploy via SFTP (password)
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ secrets.FTP_HOST }}
          port: ${{ secrets.FTP_PORT }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local_path: ./deploy/
          remote_path: ${{ secrets.REMOTE_PATH }}/
          sftp_only: true
          sftpArgs: "-o StrictHostKeyChecking=no"
